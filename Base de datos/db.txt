CREATE DATABASE sist_agropecuario;
USE sist_agropecuario;

CREATE TABLE rol (
    rolid INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE usuario (
    usuarioid INT AUTO_INCREMENT PRIMARY KEY,
    rolid INT NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    telefono VARCHAR(30),
    dni VARCHAR(20) UNIQUE,
    direccion VARCHAR(255),
    passwordhash VARCHAR(255) NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (rolid) REFERENCES rol(rolid)
);

CREATE TABLE cultivo (
    cultivoid INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE usuariocultivo (
    usuariocultivoid INT AUTO_INCREMENT PRIMARY KEY,
    usuarioid INT NOT NULL,
    cultivoid INT NOT NULL,
    latitud DECIMAL(10,8),
    longitud DECIMAL(11,8),
    fechasiembra DATE,
    FOREIGN KEY (usuarioid) REFERENCES usuario(usuarioid),
    FOREIGN KEY (cultivoid) REFERENCES cultivo(cultivoid)
);

CREATE TABLE historialcultivo (
    historialid INT AUTO_INCREMENT PRIMARY KEY,
    usuariocultivoid INT NOT NULL,
    usuarioid INT NOT NULL,
    latitud DECIMAL(10,8) NOT NULL,
    longitud DECIMAL(11,8) NOT NULL,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    observaciones TEXT,
    FOREIGN KEY (usuariocultivoid) REFERENCES usuariocultivo(usuariocultivoid),
    FOREIGN KEY (usuarioid) REFERENCES usuario(usuarioid)
);

CREATE TABLE proveedor (
    proveedorid INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    contacto VARCHAR(100),
    telefono VARCHAR(30),
    email VARCHAR(100),
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE insumo (
    insumoid INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    precio DECIMAL(10,2) NOT NULL,
    proveedorid INT,
    stock INT,
    stock_minimo INT,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (proveedorid) REFERENCES proveedor(proveedorid)
);

CREATE TABLE estadosolicitud (
    estadosolicitudid INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL
);

CREATE TABLE solicitud (
    solicitudid INT AUTO_INCREMENT PRIMARY KEY,
    usuarioid INT NOT NULL,
    fechasolicitud DATETIME DEFAULT CURRENT_TIMESTAMP,
    estadosolicitudid INT DEFAULT 1,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (usuarioid) REFERENCES usuario(usuarioid),
    FOREIGN KEY (estadosolicitudid) REFERENCES estadosolicitud(estadosolicitudid)
);

CREATE TABLE solicituddetalle (
    solicituddetalleid INT AUTO_INCREMENT PRIMARY KEY,
    solicitudid INT NOT NULL,
    insumoid INT NOT NULL,
    cantidad INT NOT NULL,
    preciounitario DECIMAL(10,2) NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (solicitudid) REFERENCES solicitud(solicitudid),
    FOREIGN KEY (insumoid) REFERENCES insumo(insumoid)
);

CREATE TABLE historialestadosolicitud (
    historialid INT AUTO_INCREMENT PRIMARY KEY,
    solicitudid INT NOT NULL,
    estadosolicitudid INT NOT NULL,
    usuarioid INT,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (solicitudid) REFERENCES solicitud(solicitudid),
    FOREIGN KEY (estadosolicitudid) REFERENCES estadosolicitud(estadosolicitudid),
    FOREIGN KEY (usuarioid) REFERENCES usuario(usuarioid)
);

CREATE TABLE pago (
    pagoid INT AUTO_INCREMENT PRIMARY KEY,
    solicitudid INT NOT NULL,
    usuarioid INT NOT NULL,
    fecha_pago DATETIME DEFAULT CURRENT_TIMESTAMP,
    monto DECIMAL(12,2) NOT NULL,
    metodo_pago VARCHAR(50),
    estado_pago VARCHAR(20) DEFAULT 'pendiente',
    observaciones TEXT,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (solicitudid) REFERENCES solicitud(solicitudid),
    FOREIGN KEY (usuarioid) REFERENCES usuario(usuarioid)
);

CREATE TABLE comprobanteentrega (
    comprobanteid INT AUTO_INCREMENT PRIMARY KEY,
    solicitudid INT NOT NULL,
    fechaentrega DATETIME,
    total DECIMAL(12,2),
    entregadopor VARCHAR(100) NOT NULL,
    recibidopor VARCHAR(100) NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (solicitudid) REFERENCES solicitud(solicitudid)
);

INSERT INTO estadosolicitud (nombre) VALUES 
    ('Pendiente'), 
    ('Aprobada'), 
    ('Cancelada'), 
    ('Rechazada');

INSERT INTO rol (nombre, activo) VALUES
('productor', TRUE),
('admin', TRUE),
('tecnico', TRUE),
('supervisor', TRUE),
('inspector', TRUE),
('gerente', TRUE);

-- SUPERADMIN
INSERT INTO usuario (rolid, nombre, email, telefono, dni, direccion, passwordhash, activo) VALUES

(2, 'Juan Perez', 'admin@agro.com', '3777889977', '45188270', 'admin123', 'hash7', TRUE);


-- PROVEEDORES
INSERT INTO proveedor (nombre, contacto, telefono, email, activo) VALUES
('AgroSur', 'Luis Benítez', '3794112233', 'luis@agrosur.com', TRUE),
('CampoFertil', 'Ana Torres', '3794335566', 'ana@campofertil.com', TRUE),
('AgroPlus', 'Daniel Ríos', '3794991122', 'daniel@agroplus.com', TRUE),
('EcoCampo', 'Rosa Medina', '3794228899', 'rosa@ecocampo.com', TRUE),
('InsuAgro', 'Héctor Silva', '3794772233', 'hector@insuagro.com', TRUE),
('ProCampo', 'Gabriel Duarte', '3794559911', 'gabriel@procampo.com', TRUE);

-- INSUMOS
INSERT INTO insumo (nombre, descripcion, precio, proveedorid, stock, stock_minimo, activo) VALUES
('Herbicida A', 'Control de malezas', 4500.00, 1, 120, 20, TRUE),
('Fertilizante B', 'Fertilizante nitrogenado', 7800.00, 2, 80, 15, TRUE),
('Semilla Soja Premium', 'Alta germinación', 12500.00, 3, 200, 50, TRUE),
('Semilla Maíz Híbrido', 'Rinde alto', 15000.00, 4, 150, 40, TRUE),
('Insecticida C', 'Control de insectos', 5900.00, 5, 60, 10, TRUE),
('Fertilizante Fosforado', 'Mejora raíces', 6900.00, 6, 100, 25, TRUE);