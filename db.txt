create database sist_agropecuario;
use sist_agropecuario;

-- ========================
-- roles y usuarios
-- ========================
create table rol (
    rolid int auto_increment primary key,
    nombre varchar(50) not null,
    activo boolean default true
);

create table usuario (
    usuarioid int auto_increment primary key,
    rolid int not null,
    nombre varchar(100) not null,
    email varchar(100) unique not null,
    telefono varchar(30),
    dni varchar(20) unique,
    direccion varchar(255),
    passwordhash varchar(255) not null,
    activo boolean default true,
    foreign key (rolid) references rol(rolid)
);

-- ========================
-- cultivos y lotes
-- ========================
create table cultivo (
    cultivoid int auto_increment primary key,
    nombre varchar(100) not null,
    descripcion text,
    activo boolean default true
);

create table usuariocultivo (
    usuariocultivoid int auto_increment primary key,
    usuarioid int not null,
    cultivoid int not null,
    latitud decimal(10,8),
    longitud decimal(11,8),
    fechasiembra date,
    foreign key (usuarioid) references usuario(usuarioid),
    foreign key (cultivoid) references cultivo(cultivoid)
);

create table historialcultivo (
    historialid int auto_increment primary key,
    usuariocultivoid int not null,        -- referencia al cultivo actual
    usuarioid int not null,                        -- quién hizo el cambio
    latitud decimal(10,8) not null,
    longitud decimal(11,8) not null,
    fecha datetime default current_timestamp,
    observaciones text,
    foreign key (usuariocultivoid) references usuariocultivo(usuariocultivoid),
    foreign key (usuarioid) references usuario(usuarioid)
);

-- ========================
-- insumos y proveedores
-- ========================
create table proveedor (
    proveedorid int auto_increment primary key,
    nombre varchar(100) not null,
    contacto varchar(100),
    telefono varchar(30),
    email varchar(100),
    activo boolean default true
);

create table insumo (
    insumoid int auto_increment primary key,
    nombre varchar(100) not null,
    descripcion text,
    precio decimal(10,2) not null,
    proveedorid int,
    estado int default true,
    stock int,
    stock_minimo int,
    foreign key (proveedorid) references proveedor(proveedorid)
);

-- ========================
-- solicitudes y estados
-- ========================
create table solicitud (
    solicitudid int auto_increment primary key,
    usuarioid int not null, -- productor
    fechasolicitud datetime default current_timestamp,
    activo boolean default true,
    foreign key (usuarioid) references usuario(usuarioid)
);

create table solicituddetalle (
    solicituddetalleid int auto_increment primary key,
    solicitudid int not null,
    insumoid int not null,
    cantidad int not null,
    preciounitario decimal(10,2) not null,
    foreign key (solicitudid) references solicitud(solicitudid),
    activo boolean default true,
    foreign key (insumoid) references insumo(insumoid)
);

-- ANIADIR PAGO
create table pago (
    pagoid int auto_increment primary key,
    solicitudid int not null,              -- referencia directa a la solicitud
    usuarioid int not null,                -- quién realizó el pago
    fecha_pago datetime default current_timestamp,
    monto decimal(12,2) not null,
    metodo_pago varchar(50),              -- 'efectivo', 'transferencia', 'tarjeta', etc.
    estado_pago varchar(20) default 'pendiente', -- 'pendiente', 'completado', 'fallido'
    observaciones text,
    activo boolean default true,
    foreign key (solicitudid) references solicitud(solicitudid),
    foreign key (usuarioid) references usuario(usuarioid)
);

create table estadosolicitud (
    estadosolicitudid int auto_increment primary key,
    nombre varchar(50) not null
);

create table historialestadosolicitud (
    historialid int auto_increment primary key,
    solicitudid int not null,
    estadosolicitudid int not null,
    usuarioid int, -- quién cambió el estado
    fecha datetime default current_timestamp,
    foreign key (solicitudid) references solicitud(solicitudid),
    foreign key (estadosolicitudid) references estadosolicitud(estadosolicitudid),
    foreign key (usuarioid) references usuario(usuarioid)
);

create table comprobanteentrega (
    comprobanteid int auto_increment primary key,
    solicitudid int not null,
    fechaentrega datetime,
    total decimal(12,2),
    entregadopor int not null,
    recibidopor int not null,
    activo boolean default true,
    foreign key (solicitudid) references solicitud(solicitudid)
);